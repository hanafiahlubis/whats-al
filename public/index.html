<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi-ALi</title>
    <style>
      * {
        padding: 0;
        margin: 0;
      }
      body {
        display: grid;
        height: 100vh;
      }
      #countainer {
        background-color: darkgray;
        display: flex;
        justify-content: space-between;
      }
      #serch {
        background-color: aquamarine;
        display: flex;
      }
      #left-countain {
        width: 30%;
        background-color: aqua;
      }
      #right-countain {
        width: 100%;
        background-color: blue;
      }
      .photo {
        width: 70px;
      }
      .photo > img {
        width: 70px;
        height: 80px;
      }
      .pesan-teman {
        display: block;
        cursor: pointer;
      }
      .user {
        display: flex;
        justify-items: center;
        align-items: flex-end;
        background: azure;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="countainer">
      <span id="left-countain">
        <span class="header">
          <span>profil</span>
          <span>kumunitas</span>
          <span>status</span>
          <span>chet baru</span>
          <span>Menu</span>
        </span>
        <div id="serch">
          <input type="url" />
          <img class="serch-right" src="" alt="dasdddasda" />
        </div>
        <div class="teman"></div>
      </span>
      <span id="right-countain">
        <div id="kontak">
          <div class="awal">
            <!-- <div class="photo"><img src="../phote/countai.jpg" alt="" /></div> -->
            <h1>WhatsApp Web</h1>
            <p>
              kirim dan terima pesan tanpa perlu menghubungkan telepon Anda ke
              Intenet <br />
              Gunakan WhatsApp di maksimal 4 perangkat tertaut dan 1 telepon
              sekaligun.
            </p>
          </div>
        </div>
      </span>
    </div>
    <script>
      let pengguna;

      const kontak = document.querySelector("#kontak");
      const awal = document.querySelector(".awal");
      fetch("/api/me")
        .then((res) => res.json())
        .then((user) => {
          console.log(user);
          // img.src = `${user.photo}`;
          // pengguna = user;
        });
      const teman = document.querySelector(".teman");

      const dataTeman = [];

      async function tampilkanTeman() {
        const res = await fetch("/api/teman");
        const data = await res.json();
        data.forEach((e, i) => {
          dataTeman[i] = e;
          const a = document.createElement("button");
          a.textContent = e.nama_lengkap;
          a.value = e.id;
          a.className = `pesan-teman`;
          teman.appendChild(a);
        });
        // const pengirim = [];
        const button = document.querySelectorAll("button");
        button.forEach((e, i) => {
          e.addEventListener("click", async () => {
            awal.innerHTML = "";

            membuatBio(i);
            pesan(e);
            tompolKirim();
            // pengirim = e;
            setTimeout(() => {
              document.kirim.onclick = async (i) => {
                i.preventDefault();

                const divUtama = document.querySelector(".container-pesan");
                const div = document.createElement("div");
                const divPesan = document.createElement("div");
                const h3 = document.createElement("h3");

                h3.textContent = document.kirim.pesan.value;
                div.className = "user";

                divPesan.appendChild(h3);
                div.appendChild(divPesan);
                divUtama.appendChild(div);
                await fetch(`/api/tambah/pesan/${e.value}`, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    pesan: document.kirim.pesan.value,
                  }),
                });
              };
            }, 1000);
          });

          e.addEventListener("dblclick", () => console.log("ok"));
        });
      }
      function membuatBio(index) {
        kontak.innerHTML = "";

        const div = document.createElement("div");
        const div2 = document.createElement("div");
        const h2 = document.createElement("h2");

        h2.textContent = dataTeman[index].username;

        div2.appendChild(h2);
        div.appendChild(div2);

        div.className = "herder-kontak";
        kontak.appendChild(div);
      }
      async function pesan(e) {
        const res = await fetch(`/api/tampil-pesan/${e.value}`);
        const data = await res.json();
        const divUtama = document.createElement("div");
        divUtama.className = "container-pesan";
        data.forEach((e) => {
          const div = document.createElement("div");
          const divPesan = document.createElement("div");
          const h3 = document.createElement("h3");

          h3.textContent = e.pesan;

          divPesan.appendChild(h3);
          div.appendChild(divPesan);
          divUtama.appendChild(div);

          e.id_pengirim === pengguna.id
            ? (div.className = "user")
            : (div.className = "penerima");
        });
        kontak.appendChild(divUtama);
      }
      async function tompolKirim() {
        setTimeout(() => {
          const div = document.createElement("div");

          const form = document.createElement("form");
          form.name = "kirim";
          const input = document.createElement("input");
          input.setAttribute("type", "text");
          input.name = "pesan";
          const button = document.createElement("button");
          button.textContent = "Kirim";
          form.appendChild(input);
          form.appendChild(button);
          div.appendChild(form);
          kontak.appendChild(div);
        }, 1000);
      }

      tampilkanTeman();
    </script>
  </body>
</html>
