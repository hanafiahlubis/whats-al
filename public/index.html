<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi-ALi</title>
    <style>
      * {
        padding: 0;
        margin: 0;
        color: #00ccff;
      }
      body {
        display: grid;
        height: 100vh;
      }
      #countainer {
        background-color: #0c1022;
        display: flex;
        justify-content: space-between;
      }
      #serch {
        display: flex;
        justify-content: center;

        border-bottom: 1px solid #ee00ff;
      }
      #serch > input {
        width: 16rem;
      }
      #left-countain {
        width: 30%;
        border-right: 1px solid #ee00ff;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .header {
        padding: 8px;
        border-bottom: 1px solid #ee00ff;
      }
      #right-countain {
        width: 100%;
      }
      .photo {
        width: 70px;
      }
      .photo > img {
        width: 70px;
        height: 80px;
      }
      .pesan-teman {
        display: flex;
        cursor: pointer;
        align-items: center;
        border-bottom: 1px solid #ee00ff;
      }
      .pesan-teman > div {
        padding: 10px;
      }

      .user {
        display: flex;
        justify-items: center;
        align-items: flex-end;
        background: azure;
        flex-direction: column;
      }
      img {
        width: 49px;
        height: 49px;
        border-radius: 50%;
      }
      .header > img {
        width: 40px;
        height: 40px;
        cursor: pointer;
      }
      .teman {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      a {
        height: 50px;
      }
      #kontak {
        height: 100%;
        display: flex;
        /* text-align: center; */
        justify-content: space-between;
        flex-direction: column;
      }
      .container-pesan {
        background: aqua;
        gap: 2px;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
      }
      .container-pesann {
        overflow-y: auto;
        height: 84vh;
        display: grid;
      }
      .herder-kontak {
        display: flex;
        height: 60px;
        align-items: center;
      }

      .herder-kontak > img {
        margin: 0 3.2% 0 0;
      }
    </style>
  </head>
  <body>
    <div id="countainer">
      <span id="left-countain">
        <span class="header">
          <img src="" alt="tidak masuk" />
        </span>
        <div id="serch">
          <input type="url" />
          <!-- <img class="serch-right" alt="dasdddasda" /> -->
        </div>
        <div class="teman"></div>
      </span>
      <span id="right-countain">
        <div id="kontak">
          <div class="awal">
            <!-- <div class="photo"><img src="../phote/countai.jpg" alt="" /></div> -->
            <h1>WhatsApp Web</h1>
            <p>
              kirim dan terima pesan tanpa perlu menghubungkan telepon Anda ke
              Intenet <br />
              Gunakan WhatsApp di maksimal 4 perangkat tertaut dan 1 telepon
              sekaligun.
            </p>
          </div>
        </div>
      </span>
    </div>
    <script>
      let pengguna;

      const kontak = document.querySelector("#kontak");
      const awal = document.querySelector(".awal");
      const img = document.querySelector(".header>img");
      fetch("/api/me")
        .then((res) => res.json())
        .then((user) => {
          pengguna = user;
          console.log(user);
          img.src = `/photos/${user.photo}`;
        });
      const teman = document.querySelector(".teman");
      img.addEventListener("click", () => (location.href = "profil"));
      const dataTeman = [];

      async function tampilkanTeman() {
        const res = await fetch("/api/teman");
        const data = await res.json();
        data.forEach((e, i) => {
          dataTeman[i] = e;
          console.log(e);
          const a = document.createElement("a");

          const divImg = document.createElement("div");
          const img = document.createElement("img");

          img.src = `/photos/${e.photo}`;
          img.alt = "Img Tidak ada";
          divImg.appendChild(img);

          const div = document.createElement("div");
          const h3 = document.createElement("h3");
          // a.textContent = e.nama_lengkap;
          h3.textContent = e.nama_lengkap;
          div.appendChild(h3);
          a.appendChild(divImg);
          a.appendChild(div);
          a.value = e.id;
          a.className = `pesan-teman`;

          teman.appendChild(a);
        });
        // const pengirim = [];
        const button = document.querySelectorAll("a");
        button.forEach((e, i) => {
          e.addEventListener("click", async () => {
            awal.innerHTML = "";

            membuatBio(i);
            pesan(e);
            tompolKirim();
            setTimeout(() => {
              document.kirim.onclick = async (i) => {
                i.preventDefault();

                const divUtama = document.querySelector(".container-pesan");
                const div = document.createElement("div");
                const divPesan = document.createElement("div");
                const h3 = document.createElement("h3");

                h3.textContent = document.kirim.pesan.value;
                div.className = "user";

                divPesan.appendChild(h3);
                div.appendChild(divPesan);
                divUtama.appendChild(div);
                setTimeout(async () => {
                  await fetch(`/api/tambah/pesan/${e.value}`, {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                      pesan: document.kirim.pesan.value,
                    }),
                  });
                }, 1000);
              };
            }, 1000);
          });

          e.addEventListener("dblclick", () => console.log("ok"));
        });
      }
      function membuatBio(index) {
        kontak.innerHTML = "";

        const div = document.createElement("div");
        const div2 = document.createElement("div");
        const h2 = document.createElement("h2");
        const img = document.createElement("img");

        img.src = `/photos/${dataTeman[index].photo}`;
        h2.textContent = dataTeman[index].username;

        div2.appendChild(h2);
        div.appendChild(img);
        div.appendChild(div2);

        div.className = "herder-kontak";
        kontak.appendChild(div);
      }
      async function pesan(e) {
        const res = await fetch(`/api/tampil-pesan/${e.value}`);
        const data = await res.json();
        const divUtama = document.createElement("div");
        divUtama.className = "container-pesann";
        const divUtama2 = document.createElement("div");
        divUtama2.className = "container-pesan";
        data.forEach((e) => {
          const div = document.createElement("div");
          const divPesan = document.createElement("div");
          const h3 = document.createElement("h3");

          h3.textContent = e.pesan;

          divPesan.appendChild(h3);
          div.appendChild(divPesan);
          divUtama2.appendChild(div);

          e.id_pengirim === pengguna.id
            ? (div.className = "user")
            : (div.className = "penerima");
        });
        divUtama.appendChild(divUtama2);
        kontak.appendChild(divUtama);
      }
      async function tompolKirim() {
        setTimeout(() => {
          const div = document.createElement("div");

          const form = document.createElement("form");
          form.name = "kirim";
          const input = document.createElement("input");
          input.setAttribute("type", "text");
          input.name = "pesan";
          const button = document.createElement("button");
          button.textContent = "Kirim";
          form.appendChild(input);
          form.appendChild(button);
          div.appendChild(form);
          kontak.appendChild(div);
        }, 1000);
      }

      tampilkanTeman();
    </script>
  </body>
</html>
