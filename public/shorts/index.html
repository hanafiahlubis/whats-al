<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mi-ALi</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <link rel="shortcut icon" href="#" type="image/x-icon" />
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 48;
      }
      * {
        padding: 0;
        margin: 0;
        color: #00ccff;
      }
      body {
        display: grid;
        height: 100vh;
        background-color: #0c1022;
        display: flex;
        justify-content: space-between;
      }

      .sidepanel {
        width: 0;
        position: fixed;
        z-index: 100;
        height: 250px;
        top: 0;
        left: 0;
        background-color: #0c1022;
        overflow-x: hidden;
        transition: 0.5s;
        padding-top: 60px;
        overflow: hidden;
      }

      .sidepanel a {
        padding: 8px 8px 8px 32px;
        text-decoration: none;
        font-size: 25px;
        display: block;
        transition: 0.3s;
      }

      .sidepanel a:hover {
        color: #ee00ff;
      }

      .sidepanel .close-btn-add {
        position: absolute;
        top: 0;
        right: 25px;
        font-size: 36px;
      }

      .open-btn {
        font-size: 20px;
        cursor: pointer;
        background-color: #0c1022;
        padding: 10px 15px;
        border: none;
      }

      .open-btn:hover {
        background-color: #444;
      }
      #serch {
        display: flex;
        justify-content: center;

        border-bottom: 1px solid #ee00ff;
      }
      #serch > input {
        width: 16rem;
      }
      #left-countain {
        width: 30%;
        border-right: 1px solid #ee00ff;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .header {
        padding: 8px;
        border-bottom: 1px solid #ee00ff;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      #right-countain {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
      }
      #right-countain > form {
        display: flex;
      }
      #right-countain > form > input {
        flex-grow: 1;
      }

      .cerita-orang {
        display: flex;
        cursor: pointer;
        align-items: center;
        border-bottom: 1px solid #ee00ff;
      }
      .cerita-orang > div {
        padding: 10px;
      }
      .penerima {
        align-self: flex-start;
        background: azure;
      }
      .user {
        align-self: flex-end;
        background: green;
        flex-direction: column;
      }
      img {
        width: 49px;
        height: 49px;
        border-radius: 50%;
        object-fit: cover;
      }
      .header > img {
        width: 40px;
        height: 40px;
        cursor: pointer;
      }
      .teman {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      a {
        height: 50px;
      }
      .container-pesan {
        background: aqua;
        gap: 2px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        flex-grow: 1;
      }
      .container-pesan > div:first-child {
        margin-top: auto;
      }
      .herder-kontak {
        display: flex;
        height: 60px;
        align-items: center;
      }

      .herder-kontak > img {
        margin: 0 3.2% 0 0;
      }
      #serch {
        display: flex;
        justify-content: center;
        padding: 10px;
        border-bottom: 1px solid #ee00ff;
      }
      #serch > input {
        width: 16rem;
        background-color: transparent;
        outline: none;
        border: none;
        border-bottom: 1px solid;
      }
      #icon-tambah {
        cursor: pointer;
      }
      #icon-tambah:hover {
        color: #ee00ff;
      }

      .container-cerita {
        background-color: rgb(59 115 110 / 22%);
        display: none;
        height: 100vh;
        width: 100%;
        z-index: 5;
        align-items: center;
        justify-content: center;
      }
      .add-cerita {
        position: relative;
        width: 400px;
        height: 470px;
        max-width: 400px;
        max-height: 470px;
        background: #040717;
        /* border-radius: 50px 5px; */
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        margin-top: 70px;
      }
      .add-cerita::before {
        position: absolute;
        width: 170%;
        height: 170%;
        content: "";
        background-image: conic-gradient(
          transparent,
          transparent,
          transparent,
          #ee00ff
        );
        animation: rotate_border 6s linear infinite;
      }
      .add-cerita::after {
        position: absolute;
        width: 170%;
        height: 170%;
        content: "";
        background-image: conic-gradient(
          transparent,
          transparent,
          transparent,
          #00ccff
        );
        animation: rotate_border 6s linear infinite;
        animation-delay: -3s;
      }
      @keyframes rotate_border {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .add-form {
        position: absolute;
        content: "";
        background-color: #0c1022;
        border-radius: 50px 5px;
        inset: 5px;
        padding: 50px 40px;
        z-index: 10;
        color: #00ccff;
      }
      h2 {
        font-size: 40px;
        font-weight: 600;
        text-align: center;
      }
      .input-group {
        margin-top: 40px;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: start;
      }
      .input-text {
        width: 95%;
        height: 30px;
        background: transparent;
        border: none;
        outline: none;
        border-bottom: 1px solid #00ccff;
        font-size: 20px;
        padding-left: 10px;
        color: #00ccff;
      }
      ::placeholder {
        font-size: 15px;
        color: #00ccff;
        letter-spacing: 1px;
        text-align: center;
      }
      .fa {
        font-size: 20px;
      }
      button {
        background-color: transparent;
        cursor: pointer;
        font-size: 25px;
      }
      button:hover {
        color: #ee00ff;
      }
      #post-button {
        position: relative;
        width: 300px;
        height: 40px;
        transition: 1s;
        margin-top: 70px;
      }
      #post-button button {
        position: absolute;
        width: 100%;
        height: 100%;
        text-decoration: none;
        z-index: 10;
        cursor: pointer;
        font-size: 22px;
        letter-spacing: 2px;
        border: 1px solid #00ccff;
        border-radius: 50px;
        background-color: #0c1022;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #00ccff;
      }
      .story-text {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 5px;
        font-size: 12px;
        z-index: 1;
      }
      .story {
        position: relative;
        display: inline-block;
      }
      .div-img {
        display: flex;
        position: relative;
        align-items: center;
        justify-content: center;
        height: 100vh;
      }
      .div-img > img {
        width: 26%;
        height: auto;
        object-fit: cover;
      }
      .caption-img {
        position: absolute;
        top: 86%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 20px;
        border-radius: 5px;
      }
      .div-video {
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .div-video > video {
        height: 90vh;
        width: 320px;
      }
      .div-video > span {
        position: absolute;
        top: 84%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
        padding: 16px;
        border-radius: 5px;
      }
      .tampil-cerita {
        display: grid;
        order: 2;
        gap: 2rem;
        overflow-y: auto;
      }
      .container2 {
        display: grid;
      }
    </style>
  </head>
  <body>
    <!-- <div>
      <video
        src="/photos/5aa41e2eabb944f6cc1a367194a69a21"
        controls
        class="story"
      ></video>
    </div> -->

    <span id="left-countain">
      <span class="header">
        <img src="" alt="tidak masuk" />
        <span class="material-symbols-outlined" id="icon-tambah">
          add_circle
        </span>
        <div id="my-sidepanel" class="sidepanel">
          <a href="javascript:void(0)" class="close-btn-add">×</a>
          <a href="/">Home</a>
          <a href="">Profil</a>
          <a href="#">Cerita</a>
          <a href="#">Keluar</a>
        </div>
        <button class="open-btn" onclick="openNav()">☰</button>
      </span>
      <div id="serch">
        <input type="text" placeholder="Cari Story...." />
      </div>
      <div class="teman"></div>
    </span>
    <span id="right-countain">
      <div class="container-cerita">
        <div class="add-cerita">
          <div class="add-form">
            <button href="javascript:void(0)" class="close-btn">×</button>
            <h2>Add Storie</h2>
            <form action="" name="kirim">
              <div class="input-group">
                <i class="fa fa-user"></i>
                <input
                  type="file"
                  class="input-text"
                  autocomplete="off"
                  required
                  name="file"
                />
              </div>
              <div class="input-group">
                <i class="fa"></i>

                <input
                  type="text"
                  placeholder="Caption"
                  class="input-text"
                  name="caption"
                  required
                  autocomplete="off"
                />
              </div>
              <div class="button-group" id="post-button">
                <button>Submit</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="container2">
        <div class="tampil-cerita"></div>
      </div>
    </span>

    <script>
      let pengguna;

      const add = document.querySelector(".container-cerita");
      const kontak = document.querySelector("#right-countain");
      const awal = document.querySelector(".awal");
      const img = document.querySelector(".header>img");
      const container = document.querySelector(".container2");
      fetch("/api/me")
        .then((res) => res.json())
        .then((user) => {
          pengguna = user;
          console.log(user);
          img.src = `/photos/${user.photo}`;
        });
      function openNav() {
        document.getElementById("my-sidepanel").style.width = "238px";
      }
      // untuk menutup menu
      document.querySelector(".close-btn-add").addEventListener("click", () => {
        document.getElementById("my-sidepanel").style.width = "0";
      });
      // untuk menutup post cerita
      document.querySelector(".close-btn").addEventListener("click", () => {
        add.style.display = "none";
        document.querySelector("#icon-tambah").style.display = "inline";
      });
      const teman = document.querySelector(".teman");

      let dataTeman = [];
      // untuk membuka profil
      img.addEventListener("click", () => (location.href = "profil"));

      document.querySelector("#icon-tambah").addEventListener("click", () => {
        document.querySelector("#icon-tambah").style.display = "none";
        if (document.querySelectorAll(".herder-kontak").length > 0) {
          document.querySelector(".herder-kontak").style.display = "none";
          document.querySelector(".tampil-cerita").style.display = "none";
        }
        add.style.display = "flex";
      });

      async function tampilkanTeman() {
        const res = await fetch("/api/teman");
        const data = await res.json();
        data.forEach((e, i) => {
          dataTeman[i] = e;
          console.log(e);
          const a = document.createElement("a");

          const divImg = document.createElement("div");
          const img = document.createElement("img");

          img.src = `/photos/${e.photo}`;
          img.alt = "Img Tidak ada";
          divImg.appendChild(img);

          const div = document.createElement("div");
          const h3 = document.createElement("h3");
          h3.textContent = e.nama_lengkap;
          div.appendChild(h3);
          a.appendChild(divImg);
          a.appendChild(div);
          a.value = e.id;
          a.className = `cerita-orang`;

          teman.appendChild(a);
        });
        const buttons = document.querySelectorAll(".cerita-orang");
        buttons.forEach((e, i) => {
          console.log(e);
          e.onclick = async () => {
            container.innerHTML = "";
            const div = document.createElement("div");
            div.className = "tampil-cerita";
            container.appendChild(div);
            // awal.innerHTML = "";
            // if (
            //   document.getElementsByName("tampilan-cerita") &&
            //   document.getElementsByClassName("herder-kontak").length > 0
            // ) {
            //   const tampilan = document.querySelector(".tampilan-cerita");
            //   tampilan.innerHTML = "";
            //   document.querySelector(".herder-kontak").innerHTML = "";
            // }
            membuatBio(i);
            cerita(e);
          };

          e.addEventListener("dblclick", () => console.log("ok"));
        });
      }

      //tambah cerita
      document.kirim.onsubmit = async (e) => {
        e.preventDefault();
        const data = new FormData();
        data.append("file", document.kirim.file.files[0]);
        data.append("caption", document.kirim.caption.value);
        await fetch("/api/story", {
          method: "POST",
          body: data,
        });

        document.kirim.file.value = "";
        document.kirim.caption.value = "";
        add.style.display = "none";
        document.querySelector(".container-cerita").style.display = "none";
        document.querySelector("#icon-tambah").style.display = "flex";
      };

      function membuatBio(index) {
        // kontak.innerHTML = "";
        // container.innerHTML = "";
        const div = document.createElement("div");
        const div2 = document.createElement("div");
        const h2 = document.createElement("h2");
        const img = document.createElement("img");

        img.src = `/photos/${dataTeman[index].photo}`;
        h2.textContent = dataTeman[index].username;

        div2.appendChild(h2);
        div.appendChild(img);
        div.appendChild(div2);

        div.className = "herder-kontak";
        container.appendChild(div);
        // kontak.appendChild(div);
      }

      async function cerita(e) {
        const div = document.querySelector(".tampil-cerita");
        const div2 = document.createElement("div");
        const res = await fetch(`/api/story/${e.value}`);
        const data = await res.json();
        data.forEach((e) => {
          file = e.media.split(".");

          const divMedia = document.createElement("div");
          if (file[1] === "img") {
            const img = document.createElement("img");
            const caption = document.createElement("span"); //belum

            img.src = `/photos/${file[0]}`;
            caption.textContent = e.caption;
            caption.className = "caption-img";
            divMedia.className = "div-img";

            divMedia.appendChild(img);
            divMedia.appendChild(caption);
            div.appendChild(divMedia);
          } else if (file[1] === "mp4") {
            const vidio = document.createElement("video");
            const caption = document.createElement("span");
            vidio.controls = true;
            vidio.autoplay = true;
            vidio.loop = true;

            vidio.src = `/photos/${file[0]}`;
            const source = document.createElement("source");
            source.type = "vidio/webm";
            source.src = `/photos/${file[0]}`;

            const source2 = document.createElement("source");
            source2.type = "vidio/mp4";
            source2.src = `/photos/${file[0]}`;
            caption.textContent = e.caption;
            divMedia.className = "div-video";

            vidio.appendChild(source);
            vidio.appendChild(source2);
            divMedia.appendChild(vidio);
            divMedia.appendChild(caption);
            div.appendChild(divMedia);
          } else {
            alert("ok");
          }
        });
      }

      async function tompolKirim(id, divUtama) {
        const form = document.createElement("form");
        form.name = "kirim";
        const input = document.createElement("input");
        input.setAttribute("type", "text");
        input.name = "pesan";
        const button = document.createElement("button");
        button.textContent = "Kirim";
        form.onsubmit = async (i) => {
          i.preventDefault();
          input.disabled = true;
          const divUtama = document.querySelector(".container-pesan");
          const div = document.createElement("div");
          const divPesan = document.createElement("div");
          const h3 = document.createElement("h3");

          h3.textContent = document.kirim.pesan.value;
          div.className = "user";

          divPesan.appendChild(h3);
          div.appendChild(divPesan);
          divUtama.appendChild(div);
          await fetch(`/api/tambah/pesan/${id}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              pesan: document.kirim.pesan.value,
            }),
          });
          divUtama.scrollTo(0, divUtama.scrollHeight);
          input.value = "";
          input.disabled = false;
        };
        form.appendChild(input);
        form.appendChild(button);
        kontak.appendChild(form);
      }

      tampilkanTeman();
    </script>
  </body>
</html>
